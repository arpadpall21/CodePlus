<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title> Server Side Rendering & Fetching </title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="../../Assets/stylesPages.css">
    <script src="../../Assets/scriptPages.js"></script>
  </head>

  <body>
    <h1> Server Side Rendering & Fetching </h1>
    <p> Updated ( 2024-11-23 ) </p>
    <nav class="sitenav">
      <a href="../../index.html" title="home">MySite > </a>
      <a href="../index.html">Next.js > </a> Server Side Rendering & Fetching
    </nav>
    <details class="example" id="notes">
      <summary> Notes & Tips :</summary>
      <!-- <p> - paragraph removes the 'empty' message from the detail TAG -->
    </details>
    <h2 style="color:green;"><u> Useful Links : </u></h2>

    <h2 style="color:green;"><u> Remember This : </u></h2>
    <p> - rendering strategies are only working in prod (always dynamic in dev), at build time a report is printed where we can see each page's rendering stategy (Static VS Dynamic) </p>
    <p> - if ISR (Incremental Static Revalidation) caching user the page is rendered dynamic </p>
    <h2 style="color:green;"><u> Description and Demonstration: </u></h2>
    <p> - Next.js support the following server side rendering strategies: </p>
    <p class="indent-lv1"> <u>Static</u> </p>
    <p class="indent-lv2"> - at build time creates a static page that is cached and served at each request </p>
    <p class="indent-lv2"> - if page contains any fetch then 'revalidates' resources (meaning fetches data then creates as static content) </p>
    <p class="indent-lv1"> <u>Dynamic</u> </p>
    <p class="indent-lv2"> - page rerendered at each request </p>
    <p class="indent-lv1"> <u>Incremental Static Regeneration (ISR)</u> </p>
    <p class="indent-lv2"> - static page that is regenerated after requesting it with a set of time (with performance in mind) </p>
    <p class="indent-lv2"> - example where the page regenerates after 1 hour: </p>
    <p class="indent-lv3"> - request within 1 hour considered fresh, so the stored page is served </p>
    <p class="indent-lv3"> - the 1st request after 1 hour (like: 1:30) considered stale, <u>still gets the old page</u>, but a new page is regenerated in the background (so subsequent requests get fresh content) </p>
    <hr>
    <!------------------------------------------------------------------------>
    <h2 class="header"> Static </h2>
    <p> - Default rendering strategy, if we don't use any of <a href="https://nextjs.org/docs/app/building-your-application/rendering/server-components#dynamic-apis" target="_blank">these Next.js APIs</a> the page is rendered static </p>
    <pre class="syntax">
                                                                  // static page by Default
    async function <reqval>ServerComponent</reqval>() {
      return <reqval>JSX</reqval>
    }
  </pre>
    <details class="example">
      <summary> DEMO (can be pseudocode) </summary>
      <pre>
    async function SomePage() {                           // normal server component
      return (
        &lt;&gt;
          &lt;h1&gt; Header &lt;/h1&gt;
          &lt;p&gt; Hello World! &lt;/p&gt;
        &lt;/&gt;
      )
    }

    export default SomePage;
    </pre>
    </details>
    <hr>
    <!---------------------------------------------------------------------------------------------->
    <h2 class="header"> Dynamic </h2>
    <p> - If we use any of <a href="https://nextjs.org/docs/app/building-your-application/rendering/server-components#dynamic-apis" target="_blank">these Next.js APIs</a> the page is rendered dynamic </p>
    <pre class="syntax">
    export const dynamic = 'force-dynamic';                             // explicitly declares this page as dynamic
    
    async function <reqval>ServerComponent</reqval>() {
      return <reqval>JSX</reqval>
    }
  </pre>
    <details class="example">
      <summary> DEMO (can be pseudocode) </summary>
      <h4 class="header"> Explicitly declared dynamic page </h4>
      <pre>
    export const dynamic = 'force-dynamic';                             // dynamic page 
    
    async function SomePage() {
      return (
        &lt;&gt;
          &lt;h1&gt; Header &lt;/h1&gt;
          &lt;p&gt; Hello World! &lt;/p&gt;
        &lt;/&gt;
      )
    }
    
    export default SomePage;
    </pre>
      <hr>
      <!------------------------------------------------------------------------>
      <h4 class="header"> Page rendered dynamically because of the use of API </h4>
      <pre>
    import { headers } from 'next/headers';           // page rendered as dynamic because of the use of this api
    
    async function SomePage() {
      const headersList = await headers()
      const id = headersList.get('X-id')
      
      return (
        &lt;&gt;
          &lt;h1&gt; Header &lt;/h1&gt;
          &lt;p&gt; Hello {id}! &lt;/p&gt;
        &lt;/&gt;
      )
    }
    
    export default SomePage;
    </pre>
    </details>
    <hr>
    <!---------------------------------------------------------------------------------------------->
    <h2 class="header"> Incremental Static Regeneration (ISR) </h2>
    <pre class="syntax">
    export const revalidate = <reqval>nr</reqval>;              // page rendered static, but regenerated after <reqval>nr</reqval> seconds (with ISR strategy)
    
    async function <reqval>ServerComponent</reqval>() {
      return <reqval>JSX</reqval>
    }
  </pre>
    <details class="example">
      <summary> DEMO (can be pseudocode) </summary>
      <pre>
    export const revalidate = 120;                          // revalidated after 2 hours
    
    async function SomePage() {
      return (
        &lt;&gt;
          &lt;h1&gt; Header &lt;/h1&gt;
          &lt;p&gt; Hello World &lt;/p&gt;
        &lt;/&gt;
      )
    }
    
    export default SomePage;
    </pre>
    </details>
    <hr>
    <!---------------------------------------------------------------------------------------------->
    <h2 class="headerExtra"> Fetching </h2>
    <p> <u>Client Side fetching</u> </p>
    <p class="indent-lv1"> - on Client side data fetching works as normal CRA </p>
    <p> <u>Server Side fetching</u> </p>
    <p class="indent-lv1"> - on server side Next.js uses the <mark>fetch()</mark> API which is basically an extension of the original <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" target="_blank">fetch()</a> with extra configurations </p>
    <p class="indent-lv1"> - the extra configurations basically control server side data caching </p>
    <pre class="syntax">
    function <reqval>ServerComponent</reqval>() {           // server side fetch
        // ...
        
        fetch(<reqval>url</reqval>, {
            cache: 'no-store' | 'force-cache',           // (<mark>no-store</mark> -> no cache used (default from Next.js v15)) (<mark>force-cache</mark> -> caches data (default before Next.js v15))
            next: {
                revalidate: false | 0 | <reqval>nr</reqval>,   // (<mark>false</mark> -> same as <mark>cache: force-cache</mark>) (<mark>0</mark> -> same as <mark>cache: no-sotre</mark>) (<mark><reqval>nr</reqval></mark> -> <u>ISR</u> revalidates the cache after <reqval>nr</reqval> seconds)
                tag: [<reqval>tag:str</reqval><optval>, ...</optval>]       // tag user by the <mark>revalidateTag(<reqval>tag:str</reqval>)</mark> hook to manually revalidate (refresh) the cache tagged by <reqval>tag</reqval>  
            }
            <a href="https:\/\/developer.mozilla.org/en-US/docs/Web/API/RequestInit" target="_blank">otherOptions...</a>
        });
    }
    </pre>
    <details class="example" open>
      <summary> DEMO (can be pseudocode) </summary>
      <h2 class="header"> Static Fetch Cache </h2>
      <pre>
    async function SomePage() {
      const response = await fetch(`http:/\/localhost:3001`, { cache: 'force-cache' });           // -! altough the default 
      const { product } = await response.json();
      return (
        &lt;&gt;
          &lt;h1&gt; Header &lt;/h1&gt;
          &lt;p&gt; Product: {product} &lt;/p&gt;
        &lt;/&gt;
      )
    }
    
    export default SomePage;
      </pre>
      <pre>
    // export const dynamic = 'force-dynamic';                  // if the page explicitly declared dynamic the below fetch cache will be dynamic (as expected)
    
    async function SomePage() {
      const response = await fetch(`http:/\/localhost:3001`);                 // -! if this page is static fetch() without cache config will be static as well (despite the fact that the default cache config is <mark>cache: no-store</mark>)    
      const { product } = await response.json();
      return (
        &lt;&gt;
          &lt;h1&gt; Header &lt;/h1&gt;
          &lt;p&gt; Product: {product} &lt;/p&gt;
        &lt;/&gt;
      )
    }
    
    export default SomePage;
      </pre>
      <hr>
      <!---------------------------------------------------------------------------------------------->
      <h2 class="header"> Dynamic Fetch Cache </h2>
      <pre>
    async function SomePage() {
      const response = await fetch(`http:/\/localhost:3001`, { cache: 'no-store' });           // no cache (results building this page dynamic)
      const { product } = await response.json();
      return (
        &lt;&gt;
          &lt;h1&gt; Header &lt;/h1&gt;
          &lt;p&gt; Product: {product} &lt;/p&gt;
        &lt;/&gt;
      )
    }
    
    export default SomePage;
      </pre>
      <!---------------------------------------------------------------------------------------------->
      <h2 class="header"> ISR Fetch Cache </h2>
      <pre>
    async function SomePage() {
      const response = await fetch(`http:/\/localhost:3001`, { next: revalidate: 60 });           // ISR cache revalidated after 1 hour (60 seconds) 
      const { product } = await response.json();
      return (
        &lt;&gt;
          &lt;h1&gt; Header &lt;/h1&gt;
          &lt;p&gt; Product: {product} &lt;/p&gt;
        &lt;/&gt;
      )
    }
    
    export default SomePage;
      </pre>
    </details>

    <!--
---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------
stage 1: high level overview 
    - read through 
    - create notes 
    - deciede what exactly will you document down 
    - UNDERSTAND AND WRITE DOWN THE CONCEPTS!!!
    
stage 2:  low level overview
    - deeper understanding of all what you've taken down in stage 1
    
stage 3 : 
    - organize and document down everything 
---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------
    - on server side fetch is used which is basically a wrapper on the browser fetch: https://nextjs.org/docs/app/api-reference/functions/fetch
    - the fetch is react server API 
      - no cache by default
      - fetch(url, {
        cache:                    // if revalidate is set this is not required
          'no-store'              <- no cache used (default from v15)
          'force-cache'           <- uses cache, returns the response from cache if it's fresh (default before v15)
        next: {
          revalidate: false | 0 | number      <- sets the cache life time (false = Infinite | 0 = disables cache | number = seconds to cache)
          tags: [tag:str, ...]                <- tags that can be used to revalidate on-demand with revalidateTag hook
        }
      })

      - we can also use this    export const revalidate = 60    to enable ISR for all fetches in the current file
          -> this option does not override fetch revalidates 
    
    

    - client side data fetching works as in normal react
    
    - mention unstable_cach spaghetti https://nextjs.org/docs/app/api-reference/functions/unstable_cache
      -> mention here that the natively supported react 'cache' hook is for this purpose (but that shit is still in canary)

    Incremental Static Regeneration 
      - the focus is performance here


- data fetching (CLARIFY this more!)
      - SSR (server side rendering) (fetched data is not cache)
      - SSG (static site generation) (fetched data is cached)
      - ISR (incremental Static Regeneration) -> well document this! (I tested it works)

- server component rendering strategies
    - static rendering 
      - page is rendered at build time after data revalidation
      - the result is cachedn and can be used in CDNs
    - dynamic rendering
      - rendered at request time 
    


    - well apparently this ting should be figured out by Next.js
      -> yes by default server components are static, Next.js figures out if it should be dynamic 
      -> server component built as static excepth when these Dynamic APIs used https://nextjs.org/docs/app/building-your-application/rendering/server-components#dynamic-apis
      -> document that we should handle any page static unless specified otherwise with      export const dynamic = 'force-dynamic'
    
    - with "export const dynamic = 'force-dynamic'" we can force a server component be to dynamic
    
    - all this server side rendering shit works in production mode only
    
    - revalidateTag tag: https://nextjs.org/docs/app/api-reference/functions/revalidateTag
        -> usable in server action or route.js (api call)
        -> tested works$
    
    - revalidatePath revalidate cached data on path : https://nextjs.org/docs/app/api-reference/functions/revalidatePath
        -> TEST IT!
        -> usable in server action or route.js (api call) TEST IT!
    
    
    - anything imported in the client component (file) will be boundled
    
    
    - in order to expose environment variables to the client we need to prefix environment variable with NEXT_PUBLIC (this is to prevent accidental leaks)
        -> empty strings will be exposed otherwise
    
    
    
    
?????????????????????????????????????????????????????????????????????????????????????????????
WRITE DOWN WHAT YOU DON'T UNDERSTAD OR MUST BE TESTED AS QUESTIONS HERE
?????????????????????????????????????????????????????????????????????????????????????????????
    - test how data caching works on client component
    
    - update router.refresh() <- kind of important
    
-->

    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
    <hr>
    <hr>
    <hr>
    <hr>
    <hr>

    <h2 class="headerExtra"><u> Title 1 </u></h2>
    <h2 class="header"> Title 1.1 </h2>
    <h3 class="header"> Title 1.1.1 </h3>
    <h4 class="header"> Title 1.1.1.1 </h4>
    <p> - stuff to learn <mark>syntax or command (or some tchnical stuff)</mark> bla bla bla </p>
    <p> - stuff to learn <mark class="mark">highlights like file names and other things</mark> bla bla bla </p>
    <p style="text-decoration:underline;"> - important information is underlined </p>
    <p style="color:yellow;"> - very important information is written with yellow colors </p>
    <p style="background-color:yellow;"> - highly important information has yellow background color </p>
    <div style="background-color:red;">
      <p> - red background block means not learned or not tested information! </p>
      <p> - </p>
    </div>

    <pre class="syntax">
    <reqval>required value </reqval>
    <optval>optional value </optval>
    <lit>literally used </lit>
    <opt>optionally used </opt>
  
    <prot style="color:#049500;">prototype chain</prot>
        
    <span class="openable"> this is an openable element<div>
        <p> - openable elements listed here in paragraphs </p>
        <p> - </p>
    </div></span>
    </pre>

    <details class="example">
      <summary> DEMO (can be pseudocode) </summary>
      <pre>
    examples of the current lessons 
    
// -----------------------------------------

// -----------------------------------------
    </pre>
    </details>

    <pre class="cmd">
    command line demo 
    </pre>
    <pre class="formula">
    formula code (like conversion meter...)
    </pre>
    <details class="example">
      <summary> Example : </summary>
      <h4 style="color:darkblue;"><u> example title </u></h4>
      <p> - live tests will come here </p>
      <details>
        <summary> CODE : </summary>
        <pre>
    copy of the exaple code 
        </pre>
      </details>
    </details>
    <!---------------------------------------------------------------------------------------------------------------------------------->
    <hr>

    <h2 class="test" style><a href="TEST/index.html"> TEST > </a></h2>

    <br><br>
  </body>

</html>